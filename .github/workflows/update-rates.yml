name: Update Currency Rates

on:
  schedule:
    - cron: '0 4 * * *'  # Daily at 12:00 AM Dominican Republic (UTC-4)
  workflow_dispatch:  # Manual trigger
  push:
    branches: [ master, main ]

jobs:
  update-rates:
    runs-on: ubuntu-latest
    
    env:
      SITE_URL: https://flarexrate.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --omit=optional

      - name: Get rates from ExchangeRate-API
        run: |
          echo "ğŸ”„ Getting rates from ExchangeRate-API..."
          curl -X GET "https://open.er-api.com/v6/latest/USD" \
            -H "Content-Type: application/json" \
            -o exchange-rates.json \
            --max-time 30 \
            --connect-timeout 10 \
            --retry 3 \
            --retry-delay 2
          
          echo "âœ… ExchangeRate-API response saved to exchange-rates.json"
          echo "ğŸ“Š Response size: $(wc -c < exchange-rates.json) bytes"

      - name: Process rates using existing functions
        run: |
          echo "ğŸ”„ Processing rates using existing scraper functions..."
          node -e "
            const { getHardcodedCurrencies } = require('./scripts/currencies.cjs');
            const fs = require('fs');
            const data = JSON.parse(fs.readFileSync('exchange-rates.json', 'utf8'));
            
            // Excluded currencies that cause 404 errors in production
            const excludedCurrencies = ['CLF', 'CNH', 'FOK', 'KID', 'SSP'];
            
            // Use rates directly (no division) - frontend handles conversion logic
            const convertedRates = {};
            Object.keys(data.rates).forEach(currency => {
              // Skip excluded currencies
              if (!excludedCurrencies.includes(currency)) {
                if (currency !== 'USD') {
                  convertedRates[currency] = data.rates[currency];
                } else {
                  convertedRates[currency] = 1;
                }
              }
            });
            
            // Create our format
            const result = {
              success: true,
              rates: convertedRates,
              currencies: Object.keys(convertedRates).map(code => {
                const currency = getHardcodedCurrencies().find(c => c.code === code);
                return {
                  code: code,
                  name: currency?.name || code,
                  symbol: currency?.symbol || code,
                  flag: \`https://www.xe.com/svgs/flags/\${code.toLowerCase()}.static.svg\`
                };
              }),
              timestamp: new Date().toISOString(),
              source: 'exchange-rate-api'
            };
            
            fs.writeFileSync('rates.json', JSON.stringify(result, null, 2));
            console.log('âœ… Converted rates saved to rates.json');
            console.log('âš ï¸  Excluded currencies:', excludedCurrencies.join(', '));
          "

      - name: Save to Netlify Blobs
        run: |
          echo "ğŸ’¾ Saving rates to Netlify Blobs..."
          
          # Create the data structure for Blobs
          cat > blob-data.json << EOF
          {
            "rates": $(cat rates.json | jq '.rates'),
            "currencies": $(cat rates.json | jq '.currencies'),
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "source": "github-actions"
          }
          EOF
          
          # Save to Netlify Blobs using Netlify Function
          curl -X PUT "${{ env.SITE_URL }}/.netlify/functions/currency-rates" \
            -H "Content-Type: application/json" \
            -d @blob-data.json
          
          echo "âœ… Rates saved to Netlify Blobs"

      - name: Update Supabase Database
        run: |
          echo "ğŸ—„ï¸ Updating Supabase database..."
          
          # Create the data structure for Supabase API
          cat > supabase-data.json << EOF
          {
            "rates": $(cat rates.json | jq '.rates')
          }
          EOF
          
          # Update Supabase using our API endpoint
          curl -X POST "${{ env.SITE_URL }}/api/rates/update" \
            -H "Content-Type: application/json" \
            -d @supabase-data.json \
            -o supabase-response.json
          
          echo "ğŸ“‹ Supabase update response:"
          cat supabase-response.json | jq '.'
          
          # Check if update was successful
          if cat supabase-response.json | jq -e '.success' > /dev/null; then
            echo "âœ… Rates updated in Supabase successfully"
          else
            echo "âŒ Failed to update Supabase"
            exit 1
          fi

      - name: Verify storage
        run: |
          echo "ğŸ” Verifying stored data..."
          curl -X GET "${{ env.SITE_URL }}/.netlify/functions/currency-rates" \
            -o verify.json
          
          echo "ğŸ“‹ Verification response:"
          cat verify.json | jq '.'
